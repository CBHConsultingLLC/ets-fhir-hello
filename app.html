<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FHIR Provider - API Testing</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <!-- FHIR Client -->
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.min.js"></script>
  <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #34495e;
      --accent-color: #3498db;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --light-gray: #ecf0f1;
      --dark-gray: #7f8c8d;
      --border-color: #bdc3c7;
    }

    body {
      background-color: #f8f9fa;
    }

    .navbar {
      background-color: var(--primary-color) !important;
    }

    .api-card {
      transition: all 0.2s ease-in-out;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }

    .api-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .card-header {
      background-color: var(--secondary-color) !important;
      color: white !important;
      border-bottom: 2px solid var(--primary-color);
    }

    .btn-primary-custom {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      color: white;
    }

    .btn-primary-custom:hover {
      background-color: #2980b9;
      border-color: #2980b9;
    }

    .btn-outline-primary-custom {
      color: var(--accent-color);
      border-color: var(--accent-color);
    }

    .btn-outline-primary-custom:hover {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      color: white;
    }

    .status-success {
      color: var(--success-color);
    }

    .status-error {
      color: var(--danger-color);
    }

    .status-loading {
      color: var(--accent-color);
    }

    .api-section {
      margin-bottom: 1.5rem;
    }

    .collapse-icon {
      transition: transform 0.2s ease-in-out;
    }

    .collapse-icon.rotated {
      transform: rotate(180deg);
    }

    .card-header .btn-link:hover {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 0.25rem;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="#">
        <i class="bi bi-heart-pulse me-2"></i>
        FHIR API Testing Dashboard
      </a>
      <span class="navbar-text" id="userInfo">
        <i class="bi bi-person-circle me-1"></i>
        Loading user...
      </span>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- API Testing Section -->
      <div class="col-lg-6">
        <!-- Connection Status -->
        <div class="alert alert-info mb-4" role="alert" id="connectionStatus">
          <i class="bi bi-wifi me-2"></i>
          <span id="statusText">Connecting to FHIR server...</span>
        </div>

        <!-- API Testing Cards - Stacked Vertically -->
        <div class="api-sections">
          <!-- Patient API -->
          <div class="api-section">
            <div class="card api-card">
              <div class="card-header">
                <h5 class="card-title mb-0">
                  <button class="btn btn-link text-white text-decoration-none p-0 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#patientCollapse" aria-expanded="false" aria-controls="patientCollapse">
                    <i class="bi bi-person me-2"></i>
                    Patient API
                    <i class="bi bi-chevron-down float-end mt-1 collapse-icon"></i>
                  </button>
                </h5>
              </div>
              <div class="collapse" id="patientCollapse">
                <div class="card-body">
                  <p class="card-text text-muted">Read patient information and demographics</p>
                  <button class="btn btn-primary-custom me-2" onclick="testPatientRead()">
                    <i class="bi bi-play-fill me-1"></i>
                    Test Patient Read
                  </button>
                  <button class="btn btn-outline-primary-custom" onclick="testPatientSearch()">
                    <i class="bi bi-search me-1"></i>
                    Search Patients
                  </button>
                  <div class="mt-3">
                    <div class="status" id="patientStatus"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Observation API -->
          <div class="api-section">
            <div class="card api-card">
              <div class="card-header">
                <h5 class="card-title mb-0">
                  <button class="btn btn-link text-white text-decoration-none p-0 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#observationCollapse" aria-expanded="false" aria-controls="observationCollapse">
                    <i class="bi bi-graph-up me-2"></i>
                    Observation API
                    <i class="bi bi-chevron-down float-end mt-1 collapse-icon"></i>
                  </button>
                </h5>
              </div>
              <div class="collapse" id="observationCollapse">
                <div class="card-body">
                  <p class="card-text text-muted">Retrieve patient observations and vital signs</p>
                  <button class="btn btn-primary-custom me-2" onclick="testObservationRead()">
                    <i class="bi bi-play-fill me-1"></i>
                    Get Observations
                  </button>
                  <button class="btn btn-outline-primary-custom" onclick="testVitalSigns()">
                    <i class="bi bi-heart-pulse me-1"></i>
                    Vital Signs
                  </button>
                  <div class="mt-3">
                    <div class="status" id="observationStatus"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Condition API -->
          <div class="api-section">
            <div class="card api-card">
              <div class="card-header">
                <h5 class="card-title mb-0">
                  <button class="btn btn-link text-white text-decoration-none p-0 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#conditionCollapse" aria-expanded="false" aria-controls="conditionCollapse">
                    <i class="bi bi-clipboard-pulse me-2"></i>
                    Condition API
                    <i class="bi bi-chevron-down float-end mt-1 collapse-icon"></i>
                  </button>
                </h5>
              </div>
              <div class="collapse" id="conditionCollapse">
                <div class="card-body">
                  <p class="card-text text-muted">Access patient conditions and diagnoses</p>
                  <button class="btn btn-primary-custom me-2" onclick="testConditionRead()">
                    <i class="bi bi-play-fill me-1"></i>
                    Get Conditions
                  </button>
                  <button class="btn btn-outline-primary-custom" onclick="testActiveConditions()">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    Active Only
                  </button>
                  <div class="mt-3">
                    <div class="status" id="conditionStatus"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Medication API -->
          <div class="api-section">
            <div class="card api-card">
              <div class="card-header">
                <h5 class="card-title mb-0">
                  <button class="btn btn-link text-white text-decoration-none p-0 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#medicationCollapse" aria-expanded="false" aria-controls="medicationCollapse">
                    <i class="bi bi-capsule me-2"></i>
                    Medication API
                    <i class="bi bi-chevron-down float-end mt-1 collapse-icon"></i>
                  </button>
                </h5>
              </div>
              <div class="collapse" id="medicationCollapse">
                <div class="card-body">
                  <p class="card-text text-muted">Review patient medications and prescriptions</p>
                  <button class="btn btn-primary-custom me-2" onclick="testMedicationRead()">
                    <i class="bi bi-play-fill me-1"></i>
                    Get Medications
                  </button>
                  <button class="btn btn-outline-primary-custom" onclick="testMedicationRequests()">
                    <i class="bi bi-prescription2 me-1"></i>
                    Prescriptions
                  </button>
                  <div class="mt-3">
                    <div class="status" id="medicationStatus"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Encounter API -->
          <div class="api-section">
            <div class="card api-card">
              <div class="card-header">
                <h5 class="card-title mb-0">
                  <button class="btn btn-link text-white text-decoration-none p-0 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#encounterCollapse" aria-expanded="false" aria-controls="encounterCollapse">
                    <i class="bi bi-hospital me-2"></i>
                    Encounter API
                    <i class="bi bi-chevron-down float-end mt-1 collapse-icon"></i>
                  </button>
                </h5>
              </div>
              <div class="collapse" id="encounterCollapse">
                <div class="card-body">
                  <p class="card-text text-muted">Access patient encounters and visits</p>
                  <button class="btn btn-primary-custom me-2" onclick="testEncounterRead()">
                    <i class="bi bi-play-fill me-1"></i>
                    Get Encounters
                  </button>
                  <button class="btn btn-outline-primary-custom" onclick="testRecentEncounters()">
                    <i class="bi bi-clock me-1"></i>
                    Recent Visits
                  </button>
                  <div class="mt-3">
                    <div class="status" id="encounterStatus"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Practitioner API -->
          <div class="api-section">
            <div class="card api-card">
              <div class="card-header">
                <h5 class="card-title mb-0">
                  <button class="btn btn-link text-white text-decoration-none p-0 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#practitionerCollapse" aria-expanded="false" aria-controls="practitionerCollapse">
                    <i class="bi bi-person-badge me-2"></i>
                    Practitioner API
                    <i class="bi bi-chevron-down float-end mt-1 collapse-icon"></i>
                  </button>
                </h5>
              </div>
              <div class="collapse" id="practitionerCollapse">
                <div class="card-body">
                  <p class="card-text text-muted">Get information about healthcare providers</p>
                  <button class="btn btn-primary-custom me-2" onclick="testPractitionerRead()">
                    <i class="bi bi-play-fill me-1"></i>
                    Get Practitioners
                  </button>
                  <button class="btn btn-outline-primary-custom" onclick="testCurrentUser()">
                    <i class="bi bi-person-check me-1"></i>
                    Current User
                  </button>
                  <div class="mt-3">
                    <div class="status" id="practitionerStatus"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let fhirClient = null;
    let currentPatientId = null;

    // Initialize FHIR client
    FHIR.oauth2.ready().then(async client => {
      fhirClient = client;
      
      try {
        // Get user information
        const user = await client.user.read().catch(() => null);
        const patient = await client.patient.read().catch(() => null);
        
        if (patient) {
          currentPatientId = patient.id;
          const name = getPatientName(patient);
          $('#userInfo').html(`<i class="bi bi-person-circle me-1"></i>Patient: ${name}`);
        } else if (user) {
          $('#userInfo').html(`<i class="bi bi-person-badge me-1"></i>User: ${user.resourceType}`);
        }

        // Update connection status
        $('#connectionStatus').removeClass('alert-info').addClass('alert-success');
        $('#statusText').html('<i class="bi bi-check-circle me-2"></i>Connected to FHIR server successfully');
        
      } catch (error) {
        $('#connectionStatus').removeClass('alert-info').addClass('alert-danger');
        $('#statusText').html('<i class="bi bi-exclamation-triangle me-2"></i>Connection failed: ' + error.message);
      }
    }).catch(error => {
      $('#connectionStatus').removeClass('alert-info').addClass('alert-danger');
      $('#statusText').html('<i class="bi bi-x-circle me-2"></i>FHIR client initialization failed: ' + error.message);
    });

    // Handle collapse icon rotation
    $('[data-bs-toggle="collapse"]').on('click', function() {
      const icon = $(this).find('.collapse-icon');
      const target = $($(this).data('bs-target'));
      
      if (target.hasClass('show')) {
        icon.removeClass('rotated');
      } else {
        icon.addClass('rotated');
      }
    });

    // Handle collapse events to ensure icon state is correct
    $('.collapse').on('shown.bs.collapse', function() {
      const button = $(`[data-bs-target="#${this.id}"]`);
      button.find('.collapse-icon').addClass('rotated');
    });

    $('.collapse').on('hidden.bs.collapse', function() {
      const button = $(`[data-bs-target="#${this.id}"]`);
      button.find('.collapse-icon').removeClass('rotated');
    });

    // Utility functions
    function getPatientName(patient) {
      if (patient.name && patient.name[0]) {
        const given = patient.name[0].given ? patient.name[0].given.join(' ') : '';
        const family = patient.name[0].family || '';
        return [given, family].filter(Boolean).join(' ') || 'Unknown Patient';
      }
      return 'Unknown Patient';
    }

    function updateStatus(elementId, status, message) {
      const statusElement = $(`#${elementId}Status`);
      statusElement.removeClass('status-success status-error status-loading');
      statusElement.addClass(`status-${status}`);
      
      const icon = status === 'success' ? 'check-circle' : status === 'error' ? 'x-circle' : 'hourglass-split';
      statusElement.html(`<i class="bi bi-${icon} me-1"></i>${message}`);
    }

    // API Test Functions
    async function testPatientRead() {
      updateStatus('patient', 'loading', 'Reading patient data...');
      
      try {
        const patient = await fhirClient.patient.read();
        const request = `GET ${fhirClient.state.serverUrl}/Patient/${patient.id}`;
        
        updateStatus('patient', 'success', `Patient loaded: ${getPatientName(patient)}`);
      } catch (error) {
        updateStatus('patient', 'error', 'Failed to read patient');
      }
    }

    async function testPatientSearch() {
      updateStatus('patient', 'loading', 'Searching patients...');
      
      try {
        const response = await fhirClient.request('Patient?_count=5');
        const request = `GET ${fhirClient.state.serverUrl}/Patient?_count=5`;
        
        updateStatus('patient', 'success', `Found ${response.total || response.entry?.length || 0} patients`);
      } catch (error) {
        updateStatus('patient', 'error', 'Failed to search patients');
      }
    }

    async function testObservationRead() {
      if (!currentPatientId) {
        updateStatus('observation', 'error', 'No patient context available');
        return;
      }
      
      updateStatus('observation', 'loading', 'Loading observations...');
      
      try {
        const response = await fhirClient.request(`Observation?patient=${currentPatientId}&_count=10`);
        const request = `GET ${fhirClient.state.serverUrl}/Observation?patient=${currentPatientId}&_count=10`;
        
        updateStatus('observation', 'success', `Found ${response.total || response.entry?.length || 0} observations`);
      } catch (error) {
        updateStatus('observation', 'error', 'Failed to load observations');
      }
    }

    async function testVitalSigns() {
      if (!currentPatientId) {
        updateStatus('observation', 'error', 'No patient context available');
        return;
      }
      
      updateStatus('observation', 'loading', 'Loading vital signs...');
      
      try {
        const response = await fhirClient.request(`Observation?patient=${currentPatientId}&category=vital-signs&_count=10`);
        const request = `GET ${fhirClient.state.serverUrl}/Observation?patient=${currentPatientId}&category=vital-signs&_count=10`;
        
        updateStatus('observation', 'success', `Found ${response.total || response.entry?.length || 0} vital signs`);
      } catch (error) {
        updateStatus('observation', 'error', 'Failed to load vital signs');
      }
    }

    async function testConditionRead() {
      if (!currentPatientId) {
        updateStatus('condition', 'error', 'No patient context available');
        return;
      }
      
      updateStatus('condition', 'loading', 'Loading conditions...');
      
      try {
        const response = await fhirClient.request(`Condition?patient=${currentPatientId}&_count=10`);
        const request = `GET ${fhirClient.state.serverUrl}/Condition?patient=${currentPatientId}&_count=10`;
        
        updateStatus('condition', 'success', `Found ${response.total || response.entry?.length || 0} conditions`);
      } catch (error) {
        updateStatus('condition', 'error', 'Failed to load conditions');
      }
    }

    async function testActiveConditions() {
      if (!currentPatientId) {
        updateStatus('condition', 'error', 'No patient context available');
        return;
      }
      
      updateStatus('condition', 'loading', 'Loading active conditions...');
      
      try {
        const response = await fhirClient.request(`Condition?patient=${currentPatientId}&clinical-status=active&_count=10`);
        const request = `GET ${fhirClient.state.serverUrl}/Condition?patient=${currentPatientId}&clinical-status=active&_count=10`;
        
        updateStatus('condition', 'success', `Found ${response.total || response.entry?.length || 0} active conditions`);
      } catch (error) {
        updateStatus('condition', 'error', 'Failed to load active conditions');
      }
    }

    async function testMedicationRead() {
      if (!currentPatientId) {
        updateStatus('medication', 'error', 'No patient context available');
        return;
      }
      
      updateStatus('medication', 'loading', 'Loading medications...');
      
      try {
        const response = await fhirClient.request(`MedicationStatement?patient=${currentPatientId}&_count=10`);
        const request = `GET ${fhirClient.state.serverUrl}/MedicationStatement?patient=${currentPatientId}&_count=10`;
        
        updateStatus('medication', 'success', `Found ${response.total || response.entry?.length || 0} medications`);
      } catch (error) {
        updateStatus('medication', 'error', 'Failed to load medications');
      }
    }

    async function testMedicationRequests() {
      if (!currentPatientId) {
        updateStatus('medication', 'error', 'No patient context available');
        return;
      }
      
      updateStatus('medication', 'loading', 'Loading medication requests...');
      
      try {
        const response = await fhirClient.request(`MedicationRequest?patient=${currentPatientId}&_count=10`);
        const request = `GET ${fhirClient.state.serverUrl}/MedicationRequest?patient=${currentPatientId}&_count=10`;
        
        updateStatus('medication', 'success', `Found ${response.total || response.entry?.length || 0} prescriptions`);
      } catch (error) {
        updateStatus('medication', 'error', 'Failed to load prescriptions');
      }
    }

    async function testEncounterRead() {
      if (!currentPatientId) {
        updateStatus('encounter', 'error', 'No patient context available');
        return;
      }
      
      updateStatus('encounter', 'loading', 'Loading encounters...');
      
      try {
        const response = await fhirClient.request(`Encounter?patient=${currentPatientId}&_count=10`);
        const request = `GET ${fhirClient.state.serverUrl}/Encounter?patient=${currentPatientId}&_count=10`;
        
        updateStatus('encounter', 'success', `Found ${response.total || response.entry?.length || 0} encounters`);
      } catch (error) {
        updateStatus('encounter', 'error', 'Failed to load encounters');
      }
    }

    async function testRecentEncounters() {
      if (!currentPatientId) {
        updateStatus('encounter', 'error', 'No patient context available');
        return;
      }
      
      updateStatus('encounter', 'loading', 'Loading recent encounters...');
      
      try {
        const response = await fhirClient.request(`Encounter?patient=${currentPatientId}&_sort=-date&_count=5`);
        const request = `GET ${fhirClient.state.serverUrl}/Encounter?patient=${currentPatientId}&_sort=-date&_count=5`;
        
        updateStatus('encounter', 'success', `Found ${response.total || response.entry?.length || 0} recent encounters`);
      } catch (error) {
        updateStatus('encounter', 'error', 'Failed to load recent encounters');
      }
    }

    async function testPractitionerRead() {
      updateStatus('practitioner', 'loading', 'Loading practitioners...');
      
      try {
        const response = await fhirClient.request('Practitioner?_count=5');
        const request = `GET ${fhirClient.state.serverUrl}/Practitioner?_count=5`;
        
        updateStatus('practitioner', 'success', `Found ${response.total || response.entry?.length || 0} practitioners`);
      } catch (error) {
        updateStatus('practitioner', 'error', 'Failed to load practitioners');
      }
    }

    async function testCurrentUser() {
      updateStatus('practitioner', 'loading', 'Loading current user...');
      
      try {
        const user = await fhirClient.user.read();
        const request = `GET ${fhirClient.state.serverUrl}/${user.resourceType}/${user.id}`;
        
        updateStatus('practitioner', 'success', `Current user: ${user.resourceType}`);
      } catch (error) {
        updateStatus('practitioner', 'error', 'Failed to load current user');
      }
    }
  </script>
</body>
</html>
